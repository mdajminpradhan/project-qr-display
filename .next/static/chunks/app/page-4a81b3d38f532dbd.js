(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{74034:(e,t,a)=>{Promise.resolve().then(a.bind(a,55736))},55736:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>y});var r=a(95155),s=a(12115),l=a(76046),n=a(5565),o=a(10142),c=a(92340),i=a.n(c),d=a(79995),m=a(28064),h=a(15255),u=a(12800),x=a(66963),g=a(27112),p=a(6215),v=a(67732);let f=e=>{let{isOpen:t,onClose:a,allRecords:l}=e,[n,c]=(0,s.useState)([]),f={"Citrus leafminer":"#FF8042",Healthy:"#00C49F","Red scale":"#FFBB28"};(0,s.useEffect)(()=>{(async()=>{if(l&&0!==l.length)try{let e={"Citrus leafminer":0,Healthy:0,"Red scale":0};l.forEach(t=>{if(t.orangeData)try{let a=JSON.parse(t.orangeData);"object"==typeof a&&null!==a&&Object.entries(a).forEach(t=>{let[a,r]=t,s=a.trim();s in e&&!isNaN(r)&&(e[s]+=Number(r))})}catch(e){console.error("Error parsing record:",e,t.orangeData)}});let t=Object.values(e).reduce((e,t)=>e+t,0),a=Object.entries(e).map(e=>{let[a,r]=e;return{name:a,value:t>0?r/t*100:0}}).sort((e,t)=>t.value-e.value);c(a)}catch(e){console.error("Error processing data:",e)}})()},[l]);let j=async()=>{try{let e=new o.jsPDF;e.setFontSize(16),e.text("Garden Analysis Report",14,20);let t=[...new Set(l.filter(e=>e.treeId).map(e=>e.treeId))];t.length>0&&(e.setFontSize(12),e.text("Trees analyzed: ".concat(t.join(", ")),14,30));let a=Math.max(...n.map(e=>e.value)),r=n.find(e=>e.value===a),s=[];r&&("Citrus leafminer"===r.name?s=["Apply neem oil spray","Remove infected leaves","Use sticky traps"]:"Red scale"===r.name?s=["Use horticultural oil","Prune affected areas","Introduce natural predators"]:"Healthy"===r.name&&(s=["Continue regular maintenance","Monitor water levels","Check soil nutrients"]));let c=n.map(e=>{let t=e.value===a;return[e.name,"".concat(e.value.toFixed(2),"%"),t?"Highest":"",t?s.join("\n"):""]}),m=t.length>0?40:30;i()(e,{head:[["Disease","Value","Status","Treatment Suggestions"]],body:c,startY:m,styles:{fontSize:10,cellPadding:5},columnStyles:{0:{cellWidth:40},1:{cellWidth:30,halign:"center"},2:{cellWidth:30,textColor:"#FF0000",halign:"center"},3:{cellWidth:60}},headStyles:{fillColor:[255,128,66],textColor:255,fontStyle:"bold"}});let h=n.map(e=>"".concat(e.name,": ").concat(e.value.toFixed(2),"%")).join("\n"),u=await d.toDataURL(h),x=e.internal.pageSize.height,g=e.lastAutoTable.finalY||30;g+60>x?(e.addPage(),e.text("Scan QR code for quick access:",14,20),e.addImage(u,"PNG",14,30,50,50)):(e.text("Scan QR code for quick access:",14,g+10),e.addImage(u,"PNG",14,g+20,50,50));let p=new Date().toISOString().replace(/[:.]/g,"-");e.save("garden-analysis-".concat(p,".pdf"))}catch(e){console.error("Error generating PDF:",e)}};if(!t)return null;let w=Math.max(...n.map(e=>e.value));return(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg w-[90%] max-w-4xl",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-2xl font-bold",children:"果园分析报告"}),l.some(e=>e.treeId)&&(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:["Trees:"," ",[...new Set(l.filter(e=>e.treeId).map(e=>e.treeId))].join(", ")]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("button",{onClick:j,className:"flex items-center gap-2 px-4 py-2 bg-amber-400 text-white rounded-md hover:bg-amber-500 transition-colors",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})}),"下载报告"]}),(0,r.jsx)("button",{onClick:a,className:"text-gray-500 hover:text-gray-700",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center",children:[(0,r.jsxs)(m.E,{width:800,height:400,data:n,margin:{top:20,right:30,left:20,bottom:5},children:[(0,r.jsx)(h.d,{strokeDasharray:"3 3"}),(0,r.jsx)(u.W,{dataKey:"name"}),(0,r.jsx)(x.h,{}),(0,r.jsx)(g.m,{}),(0,r.jsx)(p.y,{dataKey:"value",label:{position:"top"},children:n.map(e=>(0,r.jsx)(v.f,{fill:e.value===w?"#FF0000":f[e.name]},"cell-".concat(e.name)))})]}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("h3",{className:"text-xl font-semibold mb-3",children:"疾病汇总"}),(0,r.jsx)("div",{className:"flex items-center justify-center gap-6 p-4 bg-gray-50 rounded-lg",children:n.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 px-4 py-2 bg-white rounded-md shadow-sm",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:e.value===w?"#FF0000":f[e.name]}}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:e.name}),(0,r.jsxs)("span",{className:"font-bold text-lg ".concat(e.value===w?"text-red-600":""),children:[e.value.toFixed(2),"%"]})]})]},e.name))})]})]})]})})},j=e=>{let{allRecords:t}=e,a=(0,l.useRouter)(),[c,d]=(0,s.useState)(!1);(0,s.useLayoutEffect)(()=>{"true"!==localStorage.getItem("isOrangeLoggedIn")&&a.push("/login")},[a]);let m=async()=>{if(!t||0===t.length)return;let e=new o.jsPDF,a={"Citrus leafminer":["1. Apply neem oil spray.","2. Remove and destroy infested leaves.","3. Use pheromone traps to monitor infestation."],Healthy:["1. Maintain proper watering.","2. Ensure good soil health.","3. Regularly inspect for pests or diseases."],"Red scale":["1. Use horticultural oil spray.","2. Introduce natural predators like ladybugs.","3. Prune heavily infested branches."]};for(let r=0;r<t.length;r++){let s=t[r];try{let t=JSON.parse(s.orangeData),l=Object.entries(t).map(e=>{let[t,a]=e;return{name:t,value:parseFloat(a)}}),n=l.reduce((e,t)=>t.value>e.value?t:e,{name:"",value:-1/0}),o=l.map(e=>{var t;let r=e.name===n.name?(null===(t=a[e.name])||void 0===t?void 0:t.join("\n"))||"No cure points available":"";return{Name:e.name,Value:e.value,Suggestions:r}});r>0&&e.addPage(),e.setFontSize(16),e.text("Disease Analysis Report",14,20),e.setFontSize(12);let c=s.treeId?"Tree ID: ".concat(s.treeId):"Record ".concat(r+1),d=s.timestamp?new Date(s.timestamp).toLocaleString():"No date";e.text("".concat(c," - ").concat(d),14,30),i()(e,{head:[["Disease Name","Value (%)","Treatment Suggestions"]],body:o.map(e=>[e.Name,e.Value.toFixed(2),e.Suggestions]),startY:40,styles:{fontSize:10,cellPadding:4,overflow:"linebreak"},columnStyles:{0:{cellWidth:50,textColor:"#0088FE",fillColor:"#E0F7FA"},1:{cellWidth:30,textColor:"#FF8042",fillColor:"#FFF3E0"},2:{cellWidth:80,textColor:"#FFBB28",fillColor:"#FFF9C4"}}})}catch(e){console.error("Error processing record ".concat(r,":"),e)}}let r=new Date().toISOString().replace(/[:.]/g,"-");e.save("disease-analysis-".concat(r,".pdf"))};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"bg-white py-5",children:(0,r.jsxs)("div",{className:"w-4/5 mx-auto flex justify-between items-center",children:[(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"relative h-16 w-16",children:(0,r.jsx)(n.default,{src:"/images/logo.jpg",objectFit:"cover",layout:"fill",alt:"logo"})}),(0,r.jsx)("div",{className:"ml-3.5",children:(0,r.jsx)("h1",{className:"font-medium text-xl",children:"柑橘工程\\橙色计划"})})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("button",{className:"border border-amber-400 hover:bg-amber-400 hover:text-white px-4 py-2 rounded-md flex items-center whitespace-nowrap",onClick:()=>d(!0),children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 mr-2",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z"})}),"进行分析"]}),(0,r.jsxs)("button",{className:"border border-amber-400 hover:bg-amber-400 hover:text-white px-4 py-2 rounded-md flex items-center whitespace-nowrap",onClick:()=>{if(!t||0===t.length){console.error("No data to download");return}try{let e="ID,Date,Time,Tree ID,Max Disease,Max Value,Other Disease Values,Suggestions\n";t.forEach((t,a)=>{try{let r=new Date(t.timestamp),s=r.toLocaleDateString(),l=r.toLocaleTimeString(),n=JSON.parse(t.orangeData),o=Object.entries(n),c=o.reduce((e,t)=>t[1]>e[1]?t:e),i=o.filter(e=>{let[t]=e;return t!==c[0]}).map(e=>{let[t,a]=e;return"".concat(t,":").concat(a)}).join("; "),d="";"Citrus leafminer"===c[0]?d="Apply neem oil spray; Remove infected leaves; Use sticky traps":"Red scale"===c[0]?d="Use horticultural oil; Prune affected areas; Introduce natural predators":"Healthy"===c[0]&&(d="Continue regular maintenance; Monitor water levels; Check soil nutrients"),e+="".concat(a+1,",").concat(s,",").concat(l,",").concat(t.treeId||"",",").concat(c[0],",").concat(c[1],",").concat(i,',"').concat(d,'"\n')}catch(e){console.error("Error processing record:",e)}});let a=new Blob([e],{type:"text/csv;charset=utf-8;"}),r=window.URL.createObjectURL(a),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download","garden-analysis-".concat(new Date().getTime(),".csv")),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r)}catch(e){console.error("Error generating CSV:",e)}},children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 mr-2",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"})}),"形成csv文件"]}),(0,r.jsxs)("button",{className:"border border-amber-400 hover:bg-amber-400 hover:text-white px-4 py-2 rounded-md flex items-center whitespace-nowrap",onClick:m,children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 mr-2",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})}),"下载报告"]}),(0,r.jsx)("button",{className:"text-amber-400 hover:text-amber-500 px-4 py-2",onClick:()=>{localStorage.removeItem("isOrangeLoggedIn"),a.push("/login")},children:"退出"})]})]})}),(0,r.jsx)(f,{isOpen:c,onClose:()=>d(!1),allRecords:t})]})},w=(0,a(77711).default)(()=>Promise.all([a.e(579),a.e(417)]).then(a.bind(a,22417)),{loadableGenerated:{webpack:()=>[22417]},ssr:!1}),b=e=>{let{setAllRecords:t}=e,[a,l]=(0,s.useState)([]),[n,o]=(0,s.useState)(!0),c=async()=>{try{let e=await fetch("http://localhost:5500/get-data"),a=await e.json();l(a),t(a)}catch(e){console.error("Error fetching data:",e),l([])}finally{o(!1)}};return(0,s.useEffect)(()=>{c();let e=setInterval(c,5e3);return()=>clearInterval(e)},[]),(0,r.jsxs)("div",{className:"w-4/5 mx-auto my-10",children:[(0,r.jsx)("h1",{className:"text-xl font-bold",children:"图表展示"}),n?(0,r.jsx)("p",{className:"text-center mt-20",children:"Loading charts..."}):a.length>0?(0,r.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-10",children:(null==a?void 0:a.length)>0&&(null==a?void 0:a.map((e,t)=>(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-2",children:e.treeId?(0,r.jsxs)("span",{children:["树的标号: ",e.treeId]}):"Record ".concat(t+1)}),(0,r.jsx)(w,{chartData:e})]},t)))}):(0,r.jsx)("p",{className:"text-center mt-20",children:"No records found!"})]})},y=()=>{let[e,t]=(0,s.useState)([]);return(0,s.useEffect)(()=>{console.log("Current allRecords:",e)},[e]),(0,r.jsxs)("div",{children:[(0,r.jsx)(j,{allRecords:e}),(0,r.jsx)(b,{setAllRecords:t})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[930,738,671,441,517,358],()=>t(74034)),_N_E=e.O()}]);